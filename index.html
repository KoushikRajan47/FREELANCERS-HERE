<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreelanceHub - Hire & Apply</title>
    <!-- 1. Tailwind CSS for modern UI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Google Font (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://www.google.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- 3. Custom Styles -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        .line-clamp-3 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 3;
        }
        /* Hide scrollbar for a cleaner look */
        .modal-content::-webkit-scrollbar { display: none; }
        .modal-content { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">

    <!-- ========================================
         LOADING SPINNER (Initially Visible)
         ======================================== -->
    <div id="loader" class="fixed inset-0 z-50 flex items-center justify-center bg-white">
        <div class="w-16 h-16 border-4 border-t-blue-600 border-gray-200 rounded-full animate-spin"></div>
    </div>

    <!-- ========================================
         AUTHENTICATION PAGE (Initially Hidden)
         ======================================== -->
    <div id="auth-page" class="hidden min-h-screen flex items-center justify-center bg-gray-100 p-4">
        <div class="w-full max-w-md">
            <h2 class="text-3xl font-bold text-center text-blue-600 mb-6">Welcome to FreelanceHub</h2>
            <div class="bg-white rounded-lg shadow-xl p-8">
                <!-- Tabs for Login/Signup -->
                <div class="mb-6 border-b border-gray-200">
                    <nav class="flex -mb-px" aria-label="Tabs">
                        <button id="auth-tab-login" class="w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm border-blue-500 text-blue-600">Log In</button>
                        <button id="auth-tab-signup" class="w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Sign Up</button>
                    </nav>
                </div>
                <!-- Login Form -->
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="you@example.com">
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="••••••••">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-blue-700 transition duration-300">Log In</button>
                </form>
                <!-- Sign Up Form (Initially Hidden) -->
                <form id="signup-form" class="hidden">
                    <div class="mb-4">
                        <label for="signup-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                        <input type="text" id="signup-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="John Doe">
                    </div>
                    <div class="mb-4">
                        <label for="signup-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="signup-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="you@example.com">
                    </div>
                    <div class="mb-6">
                        <label for="signup-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="signup-password" minlength="6" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Min. 6 characters">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-blue-700 transition duration-300">Create Account</button>
                </form>
                <p id="auth-error" class="text-red-500 text-sm mt-4 text-center"></p>
            </div>
        </div>
    </div>

    <!-- ========================================
         MAIN APPLICATION PAGE (Initially Hidden)
         ======================================== -->
    <div id="app-page" class="hidden">
        <!-- Header / Navbar -->
        <header class="bg-white shadow-sm sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <h1 class="text-2xl font-bold text-blue-600">FreelanceHub</h1>
                    <div class="flex items-center space-x-4">
                        <span id="user-greeting" class="text-sm font-medium text-gray-600 hidden sm:block"></span>
                        <button id="open-modal-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-semibold hover:bg-blue-700 transition">Post a Service</button>
                        <button id="logout-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md text-sm font-semibold hover:bg-gray-300 transition">Logout</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Filter Section -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Browse Services</h2>
                <div id="filter-container" class="flex flex-wrap gap-2">
                    <button data-filter="all" class="filter-btn bg-blue-600 text-white px-4 py-1.5 rounded-full text-sm">All</button>
                    <button data-filter="Content Writing" class="filter-btn bg-white text-gray-700 px-4 py-1.5 rounded-full text-sm border border-gray-300 hover:bg-gray-100">Content Writing</button>
                    <button data-filter="Project Making" class="filter-btn bg-white text-gray-700 px-4 py-1.5 rounded-full text-sm border border-gray-300 hover:bg-gray-100">Project Making</button>
                    <button data-filter="Coding" class="filter-btn bg-white text-gray-700 px-4 py-1.5 rounded-full text-sm border border-gray-300 hover:bg-gray-100">Coding</button>
                    <button data-filter="Video Editing" class="filter-btn bg-white text-gray-700 px-4 py-1.5 rounded-full text-sm border border-gray-300 hover:bg-gray-100">Video Editing</button>
                    <button data-filter="Photography" class="filter-btn bg-white text-gray-700 px-4 py-1.5 rounded-full text-sm border border-gray-300 hover:bg-gray-100">Photography</button>
                    <button data-filter="Presentations" class="filter-btn bg-white text-gray-700 px-4 py-1.5 rounded-full text-sm border border-gray-300 hover:bg-gray-100">Presentations</button>
                </div>
            </div>

            <!-- Services Grid -->
            <div id="services-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Service cards will be inserted here by JavaScript -->
            </div>
             <p id="no-services-message" class="hidden text-center text-gray-500 mt-12">No services found for this category. Be the first to post one!</p>
        </main>
    </div>

    <!-- ========================================
         POST SERVICE MODAL (Initially Hidden)
         ======================================== -->
    <div id="post-service-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg overflow-hidden">
            <div class="flex justify-between items-center p-5 border-b">
                <h3 class="text-xl font-semibold text-gray-800">Offer a New Service</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <form id="service-form" class="p-6 space-y-4 max-h-[70vh] overflow-y-auto modal-content">
                <div>
                    <label for="service-title" class="block text-sm font-medium text-gray-700">Service Title</label>
                    <input type="text" id="service-title" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., I will create a modern logo for your brand">
                </div>
                <div>
                    <label for="service-description" class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea id="service-description" rows="4" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Describe the service you are offering in detail."></textarea>
                </div>
                <div>
                    <label for="service-domain" class="block text-sm font-medium text-gray-700">Domain / Category</label>
                    <select id="service-domain" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        <option>Content Writing</option>
                        <option>Project Making</option>
                        <option>Coding</option>
                        <option>Video Editing</option>
                        <option>Photography</option>
                        <option>Presentations</option>
                    </select>
                </div>
                <p id="modal-error" class="text-red-500 text-sm text-center"></p>
                <div class="pt-4 flex justify-end">
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 px-6 rounded-md font-semibold hover:bg-blue-700 transition duration-300">Post Service</button>
                </div>
            </form>
        </div>
    </div>


    <!-- ========================================
         JAVASCRIPT SECTION
         ======================================== -->
    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile, signInAnonymously, setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // =======================================================
        // YOUR FIREBASE CONFIGURATION - PASTE IT HERE!
        // =======================================================
        // This config is provided by the environment, but you can paste yours here for local testing.
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "AIzaSyCPoBCgSMptHiACr_zjsKRrAVGsGNBWQns",
  authDomain: "freelancer-here.firebaseapp.com",
  projectId: "freelancer-here",
  storageBucket: "freelancer-here.firebasestorage.app",
  messagingSenderId: "383884579649",
  appId: "1:383884579649:web:795caeb5c75af8090407c0"
            };
        // =======================================================

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Enable debug logging for Firebase
        setLogLevel('debug');

        // This ID is provided by the environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- DOM ELEMENT REFERENCES ---
        const loader = document.getElementById('loader');
        const authPage = document.getElementById('auth-page');
        const appPage = document.getElementById('app-page');
        const authError = document.getElementById('auth-error');
        const userGreeting = document.getElementById('user-greeting');
        const servicesGrid = document.getElementById('services-grid');
        const noServicesMsg = document.getElementById('no-services-message');

        // --- AUTH UI ---
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const loginTab = document.getElementById('auth-tab-login');
        const signupTab = document.getElementById('auth-tab-signup');
        
        // Tab switching logic
        loginTab.addEventListener('click', () => {
            loginForm.classList.remove('hidden');
            signupForm.classList.add('hidden');
            loginTab.classList.add('border-blue-500', 'text-blue-600');
            loginTab.classList.remove('border-transparent', 'text-gray-500');
            signupTab.classList.add('border-transparent', 'text-gray-500');
            signupTab.classList.remove('border-blue-500', 'text-blue-600');
            authError.textContent = '';
        });

        signupTab.addEventListener('click', () => {
            signupForm.classList.remove('hidden');
            loginForm.classList.add('hidden');
            signupTab.classList.add('border-blue-500', 'text-blue-600');
            signupTab.classList.remove('border-transparent', 'text-gray-500');
            loginTab.classList.add('border-transparent', 'text-gray-500');
            loginTab.classList.remove('border-blue-500', 'text-blue-600');
            authError.textContent = '';
        });

        // --- AUTH LOGIC ---
        // Handle auth in the environment
        async function initializeAuth() {
            if (typeof __initial_auth_token !== 'undefined') {
                try {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log("Signed in with custom token.");
                } catch (error) {
                    console.error("Custom token sign-in failed, signing in anonymously.", error);
                    await signInAnonymously(auth);
                }
            } else {
                console.log("No custom token, signing in anonymously.");
                await signInAnonymously(auth);
            }
        }

        // Listen for Authentication state changes
        onAuthStateChanged(auth, user => {
            loader.classList.add('hidden'); // Hide loader once auth state is determined
            if (user) {
                // User is logged in
                console.log("User signed in:", user.uid);
                authPage.classList.add('hidden');
                appPage.classList.remove('hidden');
                // Use display name if available, otherwise email, otherwise "Anonymous"
                const userName = user.displayName || user.email || (user.isAnonymous ? "Anonymous User" : "Logged In User");
                userGreeting.textContent = `Hello, ${userName}!`;
                
                // Only fetch services if NOT using our built-in auth forms
                // If using forms, wait for explicit login/signup
                if (user.isAnonymous || typeof __initial_auth_token !== 'undefined') {
                     fetchAndDisplayServices();
                }

            } else {
                // User is logged out
                console.log("User signed out.");
                appPage.classList.add('hidden');
                authPage.classList.remove('hidden');
                userGreeting.textContent = '';
            }
        });

        // Handle Sign Up
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            authError.textContent = '';

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, { displayName: name });
                console.log("User signed up:", userCredential.user.uid);
                // Manually call fetch services on successful signup
                fetchAndDisplayServices(); 
                signupForm.reset();
            } catch (error) {
                authError.textContent = error.message;
            }
        });

        // Handle Login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            authError.textContent = '';

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                console.log("User logged in:", userCredential.user.uid);
                // Manually call fetch services on successful login
                fetchAndDisplayServices();
                loginForm.reset();
            } catch (error) {
                authError.textContent = error.message;
            }
        });

        // Handle Logout
        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth);
        });

        // --- FIRESTORE & APP LOGIC ---
        
        // =======================================================
        // !! THIS IS THE FIX !!
        // We now build the correct path using the appId
        // =======================================================
        const servicesCollection = collection(db, `artifacts/${appId}/public/data/services`);

        // Render a single service card
        const renderService = (doc) => {
            const data = doc.data();
            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg shadow-md overflow-hidden transform hover:-translate-y-1 transition-transform duration-300 service-card';
            card.dataset.domain = data.domain; // For filtering
            
            const timestamp = data.createdAt?.toDate ? data.createdAt.toDate() : new Date();
            
            card.innerHTML = `
                <div class="p-6">
                    <div class="flex items-start justify-between">
                         <span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">${data.domain}</span>
                         <span class="text-xs text-gray-500">${timestamp.toLocaleDateString()}</span>
                    </div>
                    <h3 class="text-lg font-bold mt-4 text-gray-900">${data.title}</h3>
                    <p class="mt-2 text-gray-600 text-sm line-clamp-3">${data.description}</p>
                    <div class="mt-6 pt-4 border-t border-gray-200 flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-800">${data.userName || "Freelancer"}</p>
                            <p class="text-xs text-gray-500">${data.userEmail}</p>
                        </div>
                        <a href="mailto:${data.userEmail}?subject=Inquiry about your service: ${data.title}" class="bg-green-500 text-white px-4 py-2 rounded-md text-sm font-semibold hover:bg-green-600 transition">Connect</a>
                    </div>
                </div>
            `;
            servicesGrid.appendChild(card);
        }

        let allServices = []; // Cache for filtering
        let unsubscribe = null; // To store the listener
        
        // Fetch and display all services in real-time
        const fetchAndDisplayServices = () => {
            // Unsubscribe from any previous listener
            if (unsubscribe) {
                console.log("Unsubscribing from previous listener.");
                unsubscribe();
            }

            console.log("Setting up new snapshot listener for services...");
            const q = query(servicesCollection, orderBy('createdAt', 'desc'));
            
            unsubscribe = onSnapshot(q, (snapshot) => {
                console.log("Received services snapshot. Docs count:", snapshot.docs.length);
                servicesGrid.innerHTML = ''; // Clear existing grid
                allServices = snapshot.docs; // Update cache
                
                if(allServices.length === 0) {
                    noServicesMsg.classList.remove('hidden');
                } else {
                    noServicesMsg.classList.add('hidden');
                    allServices.forEach(doc => renderService(doc));
                }
            }, (error) => {
                console.error("Error fetching services: ", error);
                // This is where your console error comes from
                servicesGrid.innerHTML = `<p class="text-red-500 col-span-full text-center">Error: ${error.message}</p>`;
            });
        }

        // --- POST SERVICE MODAL LOGIC ---
        const modal = document.getElementById('post-service-modal');
        const openModalBtn = document.getElementById('open-modal-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const serviceForm = document.getElementById('service-form');
        const modalError = document.getElementById('modal-error');
        
        openModalBtn.addEventListener('click', () => modal.classList.remove('hidden'));
        closeModalBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
            serviceForm.reset();
            modalError.textContent = '';
        });

        // Handle new service form submission
        serviceForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user || user.isAnonymous) {
                modalError.textContent = "You must be fully signed up to post a service.";
                console.warn("Post attempt by anonymous user.");
                return;
            }
            
            const title = document.getElementById('service-title').value;
            const description = document.getElementById('service-description').value;
            const domain = document.getElementById('service-domain').value;

            try {
                console.log("Attempting to add document...");
                const docRef = await addDoc(servicesCollection, {
                    title: title,
                    description: description,
                    domain: domain,
                    userId: user.uid,
                    userName: user.displayName,
                    userEmail: user.email,
                    createdAt: serverTimestamp()
                });
                console.log("Document written with ID: ", docRef.id);
                // Close and reset modal on success
                closeModalBtn.click();
            } catch (error) {
                console.error("Error adding document: ", error);
                // This is where your other console error comes from
                modalError.textContent = `Failed to post service: ${error.message}`;
            }
        });

        // --- FILTERING LOGIC ---
        const filterContainer = document.getElementById('filter-container');
        filterContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('filter-btn')) {
                // Update active button style
                filterContainer.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('bg-white', 'text-gray-700');
                });
                e.target.classList.add('bg-blue-600', 'text-white');
                e.target.classList.remove('bg-white', 'text-gray-700');

                // Perform filtering
                const filterValue = e.target.dataset.filter;
                servicesGrid.innerHTML = ''; // Clear grid before re-rendering
                
                const filteredServices = filterValue === 'all'
                    ? allServices 
                    : allServices.filter(doc => doc.data().domain === filterValue);
                
                if (filteredServices.length > 0) {
                    noServicesMsg.classList.add('hidden');
                    filteredServices.forEach(doc => renderService(doc));
                } else {
                    noServicesMsg.classList.remove('hidden');
                }
            }
        });

        // Initialize Auth on page load
        initializeAuth();

    </script>
</body>
</html>

